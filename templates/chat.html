<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - ReGear</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        body { background-color: #f8f9fa; }
        .navbar { background-color: #fff !important; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .navbar-brand { font-size: 2rem; font-weight: 800; color: #002f34 !important; }
        .chat-summary { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chat-summary img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .chat-summary .price { font-size: 1.4rem; font-weight: 700; color: #0066cc; }
        .chat-summary .badges .badge { margin-right: 5px; }
        .chat-container { background: white; border-radius: 12px; height: 400px; padding: 20px; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chat-message { max-width: 75%; margin-bottom: 10px; position: relative; padding: 10px 15px; border-radius: 20px; }
        .chat-message.buyer { background: #0066cc; color: white; margin-left: auto; text-align: right; }
        .chat-message.seller { background: #f1f1f1; color: #333; margin-right: auto; }
        .chat-message .time { font-size: 0.75rem; color: #666; margin-top: 4px; }
        .message-input { position: sticky; bottom: 0; background: white; padding-top: 10px; }
        .message-input .form-control { border-radius: 20px; }
        .chat-footer { margin-top: 10px; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light sticky-top">
    <div class="container-lg">
        <a class="navbar-brand" href="/">
            <i class="fas fa-recycle me-2"></i>ReGear
        </a>
    </div>
</nav>

<div class="container-lg mt-4">
    <!-- product summary card -->
    <div class="chat-summary mb-4">
        <div class="row align-items-center">
            <div class="col-auto">
                {% set main_image = (listing.photos.split(',')[0] if listing.photos else '') %}
                {% if main_image %}
                    <img src="/{{ main_image }}" alt="{{ listing.title }}">
                {% else %}
                    <div style="width:80px;height:80px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;
                                border-radius:8px;"><i class="fas fa-image"></i></div>
                {% endif %}
            </div>
            <div class="col">
                <h5 class="mb-1">{{ listing.title }}</h5>
                <p class="price mb-1">₹{{ listing.price }}</p>
                <div class="badges mb-1">
                    <span class="badge bg-secondary">{{ listing.item_condition or 'Used' }}</span>
                    <span class="badge bg-{{ 'danger' if listing.status=='sold' else 'success' }}">{{ listing.status.capitalize() }}</span>
                </div>
                <p class="mb-1"><i class="fas fa-map-marker-alt"></i> {{ listing.location }}</p>
                <p class="mb-0 small">Seller: {{ listing.seller_name }} {% if listing.seller_rating %}⭐{{ listing.seller_rating }}{% endif %} <br><small>Last seen {{ listing.seller_last_seen or 'Unknown' }}</small></p>
            </div>
        </div>
    </div>

    <!-- chat messages -->
    <div class="chat-container" id="chatArea">
        {% for msg in messages %}
            <div class="chat-message {% if msg.sender_id == session['user_id'] %}buyer{% else %}seller{% endif %}">
                <div class="text">{{ msg.content }}</div>
                <div class="time">{{ msg.created_at.strftime('%d %b %Y %H:%M') }}</div>
            </div>
        {% endfor %}
    </div>

    <!-- input area -->
    <div class="message-input">
        <form method="post">
            <div class="input-group">
                <input type="text" name="message" class="form-control" placeholder="Type your message..." required>
                <button class="btn btn-primary" type="submit">Send</button>
                <button class="btn btn-outline-secondary" type="button"><i class="fas fa-paperclip"></i></button>
            </div>
        </form>
    </div>

    {% if session['user_id'] == conversation.seller_id and listing.status != 'sold' %}
        <div class="chat-footer">
            <form method="post" action="{{ url_for('mark_sold', conv_id=conversation.id) }}">
                <button class="btn btn-danger">Mark as Sold</button>
            </form>
        </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // auto-scroll to bottom when page loads
    var chatArea = document.getElementById('chatArea');
    if(chatArea) { chatArea.scrollTop = chatArea.scrollHeight; }
</script>
</body>
</html>